#!/bin/sh

CACHEDIR="$HOME/.cache/swaybar"
mkdir -p $CACHEDIR

bright_bar(){
    echo "💡$(brightnessctl info | grep -oP '\d+(?=%)' | head -n 1)%" > "$CACHEDIR/bright"
}

battery_bar(){
    BATTERY_PATH=$(find /sys/class/power_supply/ -maxdepth 1 -name "BAT*" | head -n 1)
    battery="$(cat ${BATTERY_PATH}/capacity)%"
    bstatus=$(cat ${BATTERY_PATH}/status)
    if [ "$bstatus" = "Charging" ]; then
        bchar="⚡"
    else 
        bchar="🔋"
    fi
    echo ${bchar}${battery} > "$CACHEDIR/battery"
}

network_bar(){
    if nmcli -t -f TYPE,STATE device | grep -q '^wifi:connected'; then 
        wifi_info=$(nmcli -t -f active,ssid,signal dev wifi | grep '^yes' | cut -d: -f2-)
        echo "🌐 $wifi_info%" > "$CACHEDIR/network"
    elif nmcli -t -f TYPE,STATE device | grep -q '^ethernet:connected'; then 
        echo "🌐 Ethernet" > "$CACHEDIR/network"
    else 
        echo "🚫 NoNet" > "$CACHEDIR/network"
    fi
}

volume_bar(){
    vol="$(wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null | tail -n 1)"
    if echo $vol | grep -q "[MUTED]";then
        vol_icon="🔇"
    else
        vol_icon="🔉"
    fi
    vol_percent=$(echo "$vol" | grep -o '[0-9]\+\.[0-9]\+' | awk '{printf "%.0f",$1 * 100}')

    echo "${vol_icon}${vol_percent}%" > "$CACHEDIR/volume"
}

microphone_bar(){
    micr="$(wpctl get-volume @DEFAULT_AUDIO_SOURCE@ 2>/dev/null | tail -n 1)"
    if echo $micr | grep -q "[MUTED]";then
        micr_icon="🙊"
    else
        micr_icon="🎤"
    fi
    micr_percent=$(echo "$micr" | grep -o '[0-9]\+\.[0-9]\+' | awk '{printf "%.0f",$1 * 100}')
    echo "${micr_icon}${micr_percent}%" > "$CACHEDIR/microphone"
}

while true; do
    battery_bar
    bright_bar
    volume_bar
    microphone_bar
    network_bar
    sleep 0.5
done
